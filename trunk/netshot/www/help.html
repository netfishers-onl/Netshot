<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Netshot - Help</title>
	
	<link rel="stylesheet" href="css/normalize.css" />
	<link rel="stylesheet" href="css/common.css" />
	<link rel="stylesheet" href="css/smoothness/jquery-ui.css" />
	<link rel="stylesheet" href="css/help.css" />

	<script data-main="js/loader-help" src="js/libs/require/require.js"></script>
</head>

<body>

<div id="menu">
	<div id="tools">
		<button id="show">Show</button>
		<button id="hide" style="display: none;">Hide</button>
	</div>
	<div id="inner">
		<div id="contents">Help Contents</div>
	</div>
</div>


<h1>Netshot Help</h1>

<div id="page">

<h2 id="quickstart">Quick Start</h2>

<h3>Install the application</h3>

<p>This assumes you are using a Debian-based Linux server, and want to deploy
all parts of Netshot on this single server. You must have a Java JRE 1.7 installed,
along with Apache and MySQL.</p>

<h4>Create a dedicated user and extract the files (as root)</h4>

<p class="code">
# adduser --system --home /usr/local/netshot --disabled-login --disabled-password netshot<br/>
# cp initd-netshot /etc/init.d/netshot<br/>
# cp ifup-netshot /etc/network/if-up.d/netshot<br/>
# cp etc-netshot.conf /etc/netshot.conf<br/>
# cp netshot.jar /usr/local/netshot<br/>
# cp -r www /usr/local/netshot<br/>
# cp apache-netshot /etc/apache2/sites-available/
</p>

<h4>Configure Apache</h4>

<p class="code">
# a2ensite netshot<br/>
# a2enmod proxy_http ssl<br/>
# make-ssl-cert /usr/share/ssl-cert/ssleay.cnf /usr/local/netshot/netshot.pem<br/>
# service apache2 restart
</p>

<p>Edit <span class="code">/etc/apache2/sites-available/netshot</span> if needed.
The provided configuration declares two name-based VirtualHost's, assuming that
the DNS name netshot points to the server. HTTP will redirect to HTTPS
automatically.</p>

<h4>Configure MySQL</h4>

<p class="code">
# mysql < mysql-netshot.sql<br/>
</p>

<p>If the current account can't access MySQL with sufficient privileges, you
may want to add user and password information to the <span class="code">mysql</span>
command line.</p>

<h3>Configure Netshot</h3>

<h4>Start Netshot</h4>

<p class="code">
# service netshot start
</p>

<h4>Login</h4>

<p>From your browser, access <a href="https://netshot">https://netshot</a>.
Enter the following credentials: username netshot, password netshot.</p>

<h4>Create accounts</h4>

<p>Go to Admin section, and create new users.</p>

<h4>Create a domain</h4>

<p>In the Admin section, add a domain.</p>

<h4>Add credential sets</h4>

<p>In the Admin section, add credential sets. You should add at least
a SNMPv1 or v2 community to be able to detect the devices, and a SSH or
Telnet account to connect to the devices.</p>

<h3>Use it!</h3>

<p>By now, you should be ready to use Netshot.</p>

<ul>
<li>In the Devices section, add devices.</li>
<li>Configure the devices to send traps/syslog messages to Netshot,
for automatic change detection.</li>
<li>Define groups to manage your devices.</li>
<li>In the Compliance section, add policies and rules.</li>
<li>If you want to force recurrent snapshots on some of the devices,
schedule tasks in the Tasks section.</li>
</ul>


<h2 id="server">Server Configuration</h2>

<p>Netshot is made of a Java daemon (the backend) and a Web application (frontend).</p>

<p class="figure" id="figure001">
<img alt="Netshot Architecture" src="img/architecture.png" />
</p>

<p>Thus to run Netshot you need to start the Netshot daemon and to set up a Web
server which will serve the Netshot static Web files and will forward the JSON
requests to the Netshot daemon.</p>

<p>The Netshot daemon, the Web server and the database can be run on different
machines (either physical or virtual).</p>

<h3>Daemon</h3>

<p>The Netshot daemon runs as a standalone application and does the following:</p>
<ul>
<li>It listens on TCP port 9996 (by default, can be customized), to be controlled
by JSON messages received on this port.</li>
<li>It connects to a database engine (e.g. MySQL, PostgreSQL) to store and
retrieve data.</li>
<li>It can listen for SNMP and Syslog messages coming from monitored network
devices to detect configuration changes.</li>
<li>It includes a scheduler to execute tasks, on a simple or recurrent manner,
such as capture the configuration of a device, check the device compliance, etc.  
</ul>

<p>The daemon is delivered as a Java application package, a .jar file.
It can be executed on any OS running a Java 1.7 Virtual Machine, using a command
line such as:</p>

<p class="code">java -jar netshot.jar</p>

<p>When started, the daemon will look for a configuration file (a simple text)
file, named netshot.conf, in the classpath, then in /etc.</p>

<h3>Database engine</h3>

<p>A database engine must run to store the data. It can be any JDBC-compatible
database (although it might be necessary to manually add the proper JDBC driver
in the Netshot daemon classpath).</p>
<p>The database access must be configured in the netshot.conf file, using
the <span class="code">netshot.db.driver_class</span>,
<span class="code">netshot.db.url</span>,
<span class="code">netshot.db.username</span> and
<span class="code">netshot.db.password</span> parameters.</p>

<p>In order to configure a MySQL database for Netshot using the MySQL CLI
(assuming the daemon and the database run on the same machine):</p>

<ol>
<li>Create the database: <span class="code">CREATE DATABASE netshot01;</span></li>
<li>Create the user and grant the proper privileges: 
<span class="code">GRANT ALL ON netshot01 TO netshot@'localhost' IDENTIFIED BY 'netshot';</span></li>
<li>Configure Netshot to use the newly created database:
<p class="code">
netshot.db.driver_class = com.mysql.jdbc.Driver<br/>
netshot.db.url = jdbc:mysql://localhost/netshot01<br/>
netshot.db.username = netshot<br/>
netshot.db.password = netshot<br/>
</p>
</li>
</ol>

<p>Netshot will create the structure (tables, keys) at the first connection.</p>

<p>Once Netshot has been started and has created the database structure, the following SQL
statement would create a local administrator account, to be temporary used to access
the application (username <em>netshot</em>, password <em>netshot</em>):</p>
<p class="code">INSERT INTO user (level, local, username, hashed_password) VALUES (1000, 1, 'netshot', '7htrot2BNjUV/g57h/HJ/C1N0Fqrj+QQ');</p>


<h3>Authentication and Authorization</h3>

<p>When using Netshot, either local or RADIUS accounts can be used.</p>

<p>Local accounts can be added in the <a href="#admin">Admin section</a> in Netshot.</p>

<p>To use RADIUS to authenticate users, the RADIUS servers must be added to the netshot.conf file.
You may declare up to two servers (the second will be used if the first one is not available):</p>

<p class="code">
netshot.auth.radiusserver1.ip = [IP RADIUS Server #1]<br/>
netshot.auth.radiusserver1.port = [UDP port RADIUS Server #1]<br/>
netshot.auth.radiusserver1.key = [RADIUS key Server #1]<br/>
netshot.auth.radiusserver2.ip = [IP RADIUS Server #2]<br/>
netshot.auth.radiusserver2.port = [UDP port RADIUS Server #2]<br/>
netshot.auth.radiusserver2.key = [RADIUS key Server #2]
</p>
<p>With this configuration, RADIUS will be used to authenticate users, but
authorization will remain local, meaning the RADIUS-authenticated users will
be given read-only permissions. To grant full privileges to the RADIUS users,
you still need to declare them in the <a href="#admin">Admin section</a>,
as remote users (no password), but as administrators.</p>


<h3>Web Server</h3>

<p>A Web server must be used to respond to HTTP requests sent by the user's Web browser.
The HTML, CSS, JavaScript, image files must be statically served.
The <span class="code">/rs</span> requests must be redirected to the Netshot daemon.</p>

<p>To configure Apache as the Web server for Netshot, assuming the Netshot Web files
are located in <span class="code">/usr/local/netshot/www</span>, enable the proxy
module and configure a VirtualHost similar to:</p>

<p class="code">
&lt;VirtualHost *:80&gt;<br/>
&nbsp;ServerName netshot<br/>
&nbsp;ServerAdmin dev@netshot.org<br/>
<br/>
&nbsp;DocumentRoot /usr/local/netshot/www<br/>
<br/>
&nbsp;&lt;Directory /usr/local/netshot/www&gt;<br/>
&nbsp;&nbsp;Options Indexes FollowSymLinks<br/>
&nbsp;&nbsp;AllowOverride None<br/>
&nbsp;&nbsp;Require all granted<br/>
&nbsp;&nbsp;Order Allow,Deny<br/>
&nbsp;&nbsp;Allow From 192.168.0.0/16<br/>
&nbsp;&lt;/Directory&gt;<br/>
<br/>
&nbsp;ErrorLog ${APACHE_LOG_DIR}/netshot-error.log<br/>
&nbsp;CustomLog ${APACHE_LOG_DIR}/netshot-access.log combine<br/>
<br/>
&nbsp;ProxyPass /rs http://127.0.0.1:9996/netshot retry=0<br/>
&nbsp;ProxyPassReverse /rs http://127.0.0.1:9996/netshot<br/>
&lt;/VirtualHost&gt;<br/>
</p>

<p>It is highly recommended to rather configure a SSL VirtualHost, in order to
protect the password exchange between the clien browser and the server.</p>

<h3>Port openings and redirections</h3>

<p>The following ports must be opened for Netshot to work properly.</p>

<table>
<thead><tr><th>Destination Port</th><th>Description and location</th><th>Source</th></tr></thead>
<tbody>
<tr><td>TCP 80, 443</td><td>HTTP/HTTPS ports on the Web server</td><td>From the client browser</td></tr>
<tr><td>TCP 9666</td><td>REST port on the Daemon server</td><td>From the Web/proxy server</td></tr>
<tr><td>E.g. TCP 1433</td><td>Database (e.g. MySQL) on the DB server</td><td>From the Netshot daemon</td></tr>
<tr><td>TCP 22, 23</td><td>Telnet and SSH on the network devices</td><td>From the Netshot daemon</td></tr>
<tr><td>UDP 161</td><td>SNMP on the network devices</td><td>From the Netshot daemon</td></tr>
<tr><td>UDP 69, 162, 514</td><td>TFTP, SNMP trap, Syslog on the Daemon server</td><td>From the network devices</td></tr>
</tbody>
</table>

<p>On most Operating Systems, if the application is started by a standard user
(which is the best option), it won't be able to listen on UDP/TCP ports like TFTP,
SNMP Trap, Syslog (ports < 1024). Consequently, by default Netshot will listen on
[port number + 1000] and will require an internal port redirection. The port number
can be customized in the netshot.conf configuration file.</p>

<p>On Linux, this can be done using <span class="code">iptables</span>.</p>

<p>For example, assuming Netshot listens for TFTP datagrams on UDP port 1069
(instead of 69), for SNMP traps on UDP port 1162 (instead of 162), for Syslog
messages on port 1514 (instead of 514), the OS TCP/IP stack can rewrite the
incoming packets with the following commands:</p>

<p class="code">
iptables -t nat -A PREROUTING -i eth0 -p udp --dport 69 -j REDIRECT --to-port 1069<br/>
iptables -t nat -A PREROUTING -i eth0 -p udp --dport 162 -j REDIRECT --to-port 1162<br/>
iptables -t nat -A PREROUTING -i eth0 -p udp --dport 514 -j REDIRECT --to-port 1514
</p>

<h2 id="devices">Devices</h2>

<h2 id="compliance">Compliance</h2>

<h3>Software Compliance</h3>

<p>Software Compliance assigns a compliance level (Gold, Silver or Bronze) to each device.
You define rules which basically say "give this level (Gold, Silver or Bronze) to any device
of type/family X and matching software version Y". The rules are stricly ordered.
When Netshot checks a device, it will take the rules in order and gives the level indicated
by the first matching rule. If no rule is hit for the given device, the Software Compliance
level will be Unknown.</p>

<p>To define Software Compliance rules, go to Compliance (top menu), then Software (left list).</p>

<ul>
<li>To add a Software Compliance rule, click on the "+" button. Then fill in the requested fields.
<ul>
<li><strong>Group</strong>: if you select a group, the rule will only apply to the devices on this group.</li>
<li><strong>Device type</strong>: you can restrict the rule to a specific device type.</li>
<li><strong>Device family</strong>: you can restrict the rule to a specific device family.</li>
<li><strong>Version</strong>: define the version you expect to see; it must precisely match (no wildcard at the moment).</li>
<li><strong>Software level</strong>: the level that will be assigned to any device matching the previous properties;
the meaning of these levels depends on your business, but you propably want to see Gold or Silver
devices on your network and will work to make Bronze or Unknown devices disappear.</li>
</ul>
</li>
<li>To edit a Software Compliance rule, click on the wrench icon.</li>
<li>To remove a Software Compliance rule, click on the trash icon, and confirm.</li>
<li>To reorder the rules, drag and drop them in the list, then confirm.</li>
</ul>

<p>Software Compliance rules are automatically evaluated after a successful Snapshot task.
They can also be manually triggered by creating a new <a href="#tasks">task</a>.</p>

<p>To see the current Compliance status of your devices, go to <a href="#reports">Reports</a>.
You can also see it for each device in the Compliance tab in the <a href="#devices">Devices</a> section.</p>

<h3>Configuration Compliance</h3>

<p>With Configuration Compliance, you may define rules which will check the configuration
and other paremeters of the devices.</p>

<h4>Policies, Rules</h4>

<p>The policies are groups of rules. They have a name and applies to a group of devices.</p>
<p>The rules do the work: they check the device and return a result of: Compliant, Non compliant,
Not applicable. For now, only JavaScript rules can be defined in Netshot.</p>

<p>Each time a Snapshot task successfully runs, a Configuration Compliance Check Task will be
started against the device; it will look for the relevant policies (i.e. policies applied to
groups the device is part of) and will run the subsequent rules. The compliance status of a
device can also be manually refreshed by scheduling a <a href="#tasks">task</a>.</p>

<p>The compliance status of a device can be seen in the Compliance page, in the <a href="#devices">Devices</a>
section. An overview is given by the relevant <a href="#reports">report</a>.</p>

<p>To add a policy, go to the Compliance section, and click on Create policy... in the top toolbar.</p>

<h4>JavaScript Rules</h4>

<p>A JavaScript rule is a piece of JavaScript code. This code will be executed by Netshot.
It can access properties of the devices, and based on that will return a compliance level.</p>

<p>The code must contain a <span class="code">check()</span> function. This function is
the one that will be run and will have to return one of these constants:

<ul>
<li><strong>CONFORMING</strong>: the device conforms with the rule.</li>
<li><strong>NONCONFORMING</strong>: the device does not conform with the rule.</li>
<li><strong>NOTAPPLICABLE</strong>: the rule does not apply to the device.</li>
</ul>

</p>

<p>Netshot-specific data and tools can be accessed through the <span class="code">Netshot</span> object.

<ul>
<li>
	<span class="code">Netshot.get(<i>item</i>)</span>: retrieve the value of a property of the current device.
	The item is a text, can be of:
	<ul>
	<li><span class="code">"config"</span>: the full (current) configuration.</li>
	<li><span class="code">"interfaces"</span>: the list of interfaces, as objects including names, addresses, etc.</li>
	<li><span class="code">"name"</span>: the name of the device.</li>
	<li><span class="code">"type"</span>: the device type (e.g. Juniper JUNOS device)</li>
	<li><span class="code">"last change date"</span>: the last date/time there was a change on the device.</li>
	<li><span class="code">"comments"</span>: the comments (as manually defined when editing the device in Netshot).</li>
	<li><span class="code">"creation date"</span>: the date/time the device was created in Netshot.</li>
	<li><span class="code">"contact"</span>: the contact for the device.</li>
	<li><span class="code">"location"</span>: the location of the device.</li>
	<li><span class="code">"family"</span>: the family (e.g. Catalyst 6500).</li>
	<li><span class="code">"management ip"</span>: the management IP address (used to access the device from Netshot).</li>
	<li><span class="code">"domain"</span>: the Netshot domain of the device.</li>
	<li><span class="code">"modules"</span>: the list of modules in the device.</li>
	<li><span class="code">"network class"</span>: the network class (e.g. firewall, router, switch, etc.).</li>
	<li><span class="code">"device status"</span>: the status of the device {DISABLED, INPRODUCTION, PREPRODUCTION}.</li>
	<li><span class="code">"virtual devices"</span>: the list of virtual devices (e.g. VDC's for Nexus devices).</li>
	<li><span class="code">"vrf instances"</span>: the list of VRF instances.</li>
	<li><span class="code">"config change date"</span>: the last configuration change date/time.</li>
	<li>Plus other family-specific variables, like <span class="code">startup-config</span>
	for an IOS device.</li>
	</ul>
</li>
<li><span class="code">Netshot.get(<i>item</i>, <i>device</i>)</span>: same as above, but retrieve data
from another device, identified by its numeric ID.</li>
<li><span class="code">Netshot.nslookup(<i>arg1</i>)</span>: Netshot will try to resolve the name or the IP (reverse lookup) passed as arg1;
this is useful to implement rules that check the registration of your standard FQDN.</li>
<li><span class="code">Netshot.debug(<i>text</i>)</span>: the text will be logged into the debug buffer, when testing the script.</li>
</ul>
</p>

<p>A minimal rule that all devices would conform with would be:</p>

<p class="code">
function check() {<br/>
&nbsp;&nbsp;return CONFORMING;<br/>
}
</p>

<p>You can also include a comment in the result, this comment would appear in the
device compliance status:</p>

<p class="code">
function check() {<br/>
&nbsp;&nbsp;return {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;result: NONCORMING,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;comment: "Missing some part of the standard configuration"<br/>
&nbsp;&nbsp;}<br/>
}
</p>

<p>The following rule would check the device name with a regular expression. If the name
matches the expression, the device is compliant:</p>

<p class="code">
function check() {<br/>
&nbsp;&nbsp;var name = Netshot.get('name');<br/>
&nbsp;&nbsp;if (name.match(/^ZR[0-9][0-9][0-9][0-9][0-9]$/)) {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;return CONFORMING;<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;return {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;result: NONCONFORMING,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;comment: "Invalid name"<br/>
&nbsp;&nbsp;}<br/>
}
</p>

<p>The following rule will check that the <span class="code">no ip redirects</span> command
is applied to each interface configuration block (Cisco IOS context).</p>

<p class="code">
function findBlocks(pattern, text) {<br/>
&nbsp;var r = new RegExp("(?:^|\\n)(\\s*)(" + pattern.source + ")(((?:\\r?)\\n\\1\\s.*)*)", "g");<br/>
&nbsp;var blocks = [];<br/>
&nbsp;while ((block = r.exec(text)) !== null) {<br/>
&nbsp;&nbsp;blocks.push(block);<br/>
&nbsp;}<br/>
&nbsp;return blocks;<br/>
}<br/>
<br/>
function check() {<br/>
&nbsp;var config = Netshot.get('config');<br/>
&nbsp;var interfaceConfigs = findBlocks(/interface .*/, config);<br/>
&nbsp;for (var i in interfaceConfigs) {<br/>
&nbsp;&nbsp;if (!interfaceConfigs[i][3].match(/^ no ip redirects/m)) {<br/>
&nbsp;&nbsp;&nbsp;return NONCONFORMING;<br/>
&nbsp;&nbsp;}<br/>
&nbsp;}<br/>
&nbsp;return CONFORMING;<br/>
}
</p>

<h2 id="tasks">Tasks</h2>

<h2 id="reports">Reports</h2>

<h2 id="admin">Administration</h2>

</div>

</body>
</html>